---
import { getCollection } from 'astro:content'
import TopBar from './TopBar.astro'
import Logo from './Logo.astro'
import Button from './Button.astro'
import { Icon } from 'astro-icon/components'

// Get all services
const allServices = await getCollection('service')
const services = allServices
	.filter((item) => !item.data.draft)
	.sort((a, b) => {
		// Sort by order first, then by title
		if (a.data.order !== b.data.order) {
			return a.data.order - b.data.order
		}
		return a.data.title.localeCompare(b.data.title)
	})

// Get all service areas
const allAreas = await getCollection('serviceAreas')
const areas = allAreas
	.filter((item) => !item.data.draft)
	.sort((a, b) => {
		// Sort by order first, then by title
		if (a.data.order !== b.data.order) {
			return a.data.order - b.data.order
		}
		return a.data.title.localeCompare(b.data.title)
	})

const navItems = [
	{ name: 'Home', href: '/' },
	{ name: 'About', href: '/about' },
	{
		name: 'Services',
		href: '/services',
		children: services
	},
	{
		name: 'Areas We Serve',
		href: '/areas-we-serve',
		children: areas
	},
	{ name: 'FAQs', href: '/faqs' },
	{ name: 'Gallery', href: '/gallery' }
	// { name: "Projects", href: "/project" },
	// { name: "Blogs", href: "/blog" },
]
---

<TopBar />

<header class="bg-white shadow-md sticky top-0 z-50" x-data="{ open: false }">
	<div class="max-w-7xl mx-auto px-4">
		<!-- TOP ROW -->
		<div class="flex justify-between items-center py-4">
			<!-- LOGO -->
			<div class="flex items-center gap-3 h-auto">
				<Logo />
			</div>

			<!-- DESKTOP NAV -->
			<nav class="hidden lg:flex items-center gap-4">
				{
					navItems.map((item) => (
						<span data-nav-item class="relative flex items-center">
							<a href={item.href} class="inline-block text-dark hover:text-primary font-medium transition p-2">
								{item.name}
							</a>
							{item.children && (
								<button
									data-nav-chevron
									aria-expanded="false"
									aria-controls={`nav-${item.href.slice(1)}`}
									class="hover:text-primary aria-expanded:text-primary transition p-1"
								>
									<Icon name="bi:chevron-down" />
								</button>
								<ul
									class="absolute min-w-full top-full -left-3 bg-white p-2 rounded-lg shadow-xl"
									id={`nav-${item.href.slice(1)}`}
								>
									{item.children.map((subitem) => (
										<li>
											<a
												class="block w-full bg-white rounded-md transition text-dark hover:text-primary font-medium transition px-3 py-1.5 whitespace-nowrap cursor-pointer"
												href={`${item.href}/${subitem.slug}`}
											>
												{subitem.data.title}
											</a>
										</li>
									))}
								</ul>
							)}
						</span>
					))
				}

				<!-- BUTTON -->
				<Button href="tel:9373690346" variant="primary" size="sm" icon="bi:telephone-fill"> (937) 369-0346 </Button>
			</nav>
			
			<Button href="tel:9373690346" variant="primary" size="sm" icon="bi:telephone-fill" class="ml-auto !w-min lg:hidden whitespace-nowrap">
				(937) 369-0346
			</Button>

			<!-- MOBILE TOGGLE -->
			<button x-on:click="open = !open" class="lg:hidden text-dark text-3xl ml-4" aria-label="Toggle Mobile Menu">
				<span x-show="!open">
					<Icon name="bi:list" />
				</span>

				<span x-show="open" style="display: none;">
					<Icon name="bi:x-lg" />
				</span>
			</button>
		</div>

		<!-- MOBILE MENU -->
		<nav x-show="open" x-transition style="display: none;" class="lg:hidden pb-4 flex flex-col gap-1">
			{
				navItems.map((item) => (
					<a href={item.href} class="block py-2 text-dark hover:text-primary transition">
						{item.name}
					</a>
				))
			}

			<Button href="tel:9373690346" variant="primary" size="sm" icon="bi:telephone-fill" class="w-full mt-2 whitespace-nowrap">
				(937) 369-0346
			</Button>
		</nav>
	</div>
</header>

<script>
	const chevronButtons = document.querySelectorAll('[data-nav-chevron][aria-expanded]') as NodeListOf<HTMLButtonElement>
	for (const button of chevronButtons) {
		const navItem = button.closest('[data-nav-item]')

		button.addEventListener('click', () => {
			if (button.ariaExpanded === 'false') {
				button.ariaExpanded = 'true'
			} else {
				button.ariaExpanded = 'false'
			}
		})

		document.addEventListener('click', (event) => {
			if (event.target instanceof Node && !navItem?.contains(event.target)) {
				button.ariaExpanded = 'false'
			}
		})

		document.addEventListener('keydown', (event) => {
			if (event.key === 'Escape') {
				button.ariaExpanded = 'false'
			}
		})
	}
</script>

<style>
	[data-nav-chevron] + ul {
		display: none;
	}
	[data-nav-chevron][aria-expanded='true'] + ul {
		display: block;
	}
</style>
---
import MainLayout from "@src/layouts/MainLayout.astro";
import AuthorCard from "@src/components/AuthorCard.astro";
import BlogCard from "@src/components/BlogCard.astro";
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async () => {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content } = await post.render();
const data = post.data;

// Convert date
const postDate = typeof data.date === "string" ? new Date(data.date) : data.date;
const formattedDate = new Intl.DateTimeFormat("id-ID", {
  year: "numeric",
  month: "long",
  day: "numeric",
}).format(postDate);

// Related posts
const allPosts = await getCollection("blog");
const related = allPosts
  .filter((p) => p.data.category === data.category && p.slug !== post.slug)
  .slice(0, 3);
---

<MainLayout title={`${data.title} – Constructors Blog`}>
  <!-- Heading Hero (pakai cover MDX) -->
  <div class="relative py-24 lg:py-32 overflow-hidden">
    <div class="absolute inset-0">
      <img 
        src={data.cover} 
        alt={data.title} 
        class="w-full h-full object-cover" 
      />
      <div class="absolute inset-0 bg-linear-to-r from-black/95 via-black/80 to-black/60"></div>
    </div>
    <div class="relative z-10 max-w-5xl mx-auto px-4 text-center text-white">
      <span class="inline-block bg-primary-soft text-primary-dark px-4 py-2 rounded-full text-sm font-semibold mb-6">
        {data.category}
      </span>
      <h1 class="font-display text-4xl md:text-6xl font-bold leading-tight mb-6">
        {data.title}
      </h1>
      <div class="inline-flex h-1 pipe-divider w-32 mx-auto mb-8"></div>
      <div class="flex items-center justify-center gap-6 text-gray-200">
        <time datetime={postDate.toISOString()}>{formattedDate}</time>
        <span>•</span>
        <span>{data.readTime} min read</span>
      </div>
    </div>
  </div>

  <!-- Content -->
  <article class="pb-16 pt-8 md:py-16 bg-white">
    <div class="max-w-5xl mx-auto px-4">
      <div class="post-content">
        <Content />
      </div>
    </div>

    <!-- Tags -->
    {data.tags && data.tags.length > 0 && (
      <div class="max-w-5xl mx-auto px-4 flex flex-wrap gap-3 mt-12">
        {data.tags.map((tag) => (
          <span class="bg-primary-soft text-primary-dark px-4 py-2 rounded-full text-sm font-semibold">
            #{tag}
          </span>
        ))}
      </div>
    )}
  </article>

  <!-- Author -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-5xl mx-auto px-4">
      <AuthorCard author={data.author} />
    </div>
  </section>

  <!-- Related Posts -->
  {related.length > 0 && (
    <section class="py-20 bg-white">
      <div class="max-w-7xl mx-auto px-4">
        <h2 class="font-display text-4xl text-center font-bold mb-12">
          Related Articles
        </h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-10">
          {related.map((r) => <BlogCard post={r} />)}
        </div>
      </div>
    </section>
  )}
</MainLayout>